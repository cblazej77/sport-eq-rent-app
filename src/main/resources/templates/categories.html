<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title th:text="#{cat_title}"></title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<div class="top-lane">
    <div class="top-lane-section">
        <h1 class="txt-white">Sport equipment rent</h1>
        <div class="nav-container">
            <a class="nav-button nav-btn-clicked" th:text="#{cat_title}"></a>
            <button class="nav-button"
                    th:if="${user != null}"
                    th:text="#{cat_redirect_reservations}"
                    th:onclick="window.location.href='/reservations';"></button>
        </div>
    </div>
    <div class="top-lane-account">
        <a th:if="${user == null}" th:href="@{/sign_in}" class="nav-button" th:text="#{eq_btn_sign_in}"></a>
        <div th:if="${user != null}" style="display: flex; flex-direction: column;">
            <div style="margin-bottom: 10px;">
                <label class="txt-white" th:text="#{nav.logged(${user.email})}"></label>
                <label class="txt-white" th:if="${user.role == 'ADMIN'}" th:text="[ADMIN]"></label>
            </div>
            <button class="nav-button" th:text="#{cat_btn_logout}"
                    th:onclick="window.location.href='/logout';"></button>
        </div>
        <form method="get" action="#">
            <select style="margin-left: 5px;" name="lang" onchange="this.form.submit()">
                <option value="pl" th:selected="${#locale.language == 'pl'}">PL</option>
                <option value="en" th:selected="${#locale.language == 'en'}">EN</option>
                <option value="es" th:selected="${#locale.language == 'es'}">ES</option>
                <option value="fr" th:selected="${#locale.language == 'fr'}">FR</option>
            </select>
        </form>
    </div>
</div>
<div class="center-body">
    <div th:if="${user != null and user.role == 'ADMIN'}" class="category-container cat-new-container"
         onclick="showModal(null)">
        <div class="plus-container">
            <i class="bi bi-plus-lg plus-icon"></i>
            <h2 th:text="#{cat_btn_add}"></h2>
        </div>
    </div>
    <div th:each="category : ${categories}" class="category-container"
         th:onclick="window.location.href=/*[[@{/categories/{id}(id=${category.categoryID})}]]*/"
         th:classappend="${category.quantity == 0} ? 'faded' : ''">
        <img th:src="@{/categories/image/{id}(id=${category.categoryID})}" alt="Category Image"
             class="cat-img"/>
        <h2 th:text="${category.name}"></h2>
        <label style="font-size: 18px; cursor: pointer;" class="txt-gray"
               th:text="#{cat_quantity} + ${category.quantity}"></label>
        <div th:if="${user != null && user.role == 'ADMIN'}" class="filter-divider" style="margin: 20px 0px;"></div>
        <div class="cat-btn-div">
            <a th:if="${user != null and user.role == 'ADMIN'}"
               th:data-id="${category.categoryID}"
               th:data-name="${category.name}"
               th:data-image="@{/categories/image/{id}(id=${category.categoryID})}"
               th:text="#{cat_btn_edit}"
               onclick="event.stopPropagation(); showModal(this)"
               class="btn">
            </a>
            <form class="deleteForm" id="deleteForm" method="post"
                  th:action="@{/categories/delete/{id}(id=${category.categoryID})}"
                  th:if="${user != null and user.role == 'ADMIN'}" onclick="event.stopPropagation()">
                <input type="hidden" name="_method" value="DELETE">
                <button style="border: 0px;" type="submit" th:text="#{cat_btn_delete}"></button>
            </form>
        </div>
    </div>
</div>

<div id="modal" class="modal-overlay" onclick="hideModal()">
    <form id="categoryForm" enctype="multipart/form-data" method="POST">
        <input type="hidden" id="hiddenMethod" name="_method" value="POST">
        <div class="modal-window" onclick="event.stopPropagation();">
            <h2 id="modal-title" th:text="cat_btn_edit"></h2>
            <input type="hidden" id="categoryID" name="categoryID">
            <label th:text="#{cat_modal_img}"></label>
            <div class="modal-image-div" onclick="triggerFileInput()">
                <img id="preview" class="modal-image"/>
            </div>
            <input type="file" id="fileInput" name="image" accept="image/*" style="display: none;"
                   onchange="previewImage(event)">
            <input class="modal-input" type="text" id="categoryName" name="name" th:placeholder="#{cat_modal_name}">
            <span id="catBtnAdd" th:text="#{cat_btn_add}" style="display: none;"></span>
            <span id="catBtnEdit" th:text="#{cat_btn_edit}" style="display: none;"></span>
            <button class="modal-btn btn-action" id="saveButton" type="submit" th:text="#{cat_modal_save}"></button>
            <button class="modal-btn" type="button" onclick="hideModal()" th:text="#{cat_modal_cancel}"></button>
        </div>
    </form>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script th:src="@{/js/categories.js}"></script>
<script th:inline="javascript">
document.querySelectorAll(".deleteForm").forEach(form => {
    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const actionUrl = form.getAttribute("action");

        fetch(actionUrl, {
            method: "DELETE"
        })
        .then(res => {
            if (res.ok) {
                showToast([[#{cat.toast.deleted}]], "success");
                setTimeout(() => {
                    location.reload();
                }, 1200);
            } else {
                showToast([[#{error.unknown}]], "error");
            }
        })
        .catch(() => showToast([[#{error.unknown}]], "error"));
    });
});

document.getElementById("categoryForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const method = form.querySelector("#hiddenMethod").value;
    const isEdit = method === "PUT";

    const url = isEdit ? "/categories/edit" : "/categories/add";

    fetch(url, {
        method: isEdit ? "PUT" : "POST",
        body: formData
    })
    .then(async res => {
        if (!res.ok) {
            try {
                const errors = await res.json();
                errors.forEach(err => showToast(err, "error"));
            } catch {
                showToast([[#{error.unknown}]], "error");
            }
        } else {
            const successMessage = isEdit
                ? [[#{cat.toast.edited}]]
                : [[#{cat.toast.added}]];
            showToast(successMessage, "success");
            hideModal();
            form.reset();
            setTimeout(() => {
                location.reload();
            }, 1200);
        }
    })
    .catch(() => showToast([[#{error.unknown}]], "error"));
});

function showToast(msg, type = "success") {
    Toastify({
        text: msg,
        duration: 3000,
        gravity: "top",
        position: "center",
        background: type === "error" ? "var(--primary)" : "green",
    }).showToast();
}


</script>
</body>
</html>