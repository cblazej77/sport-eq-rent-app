<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title th:text="#{res_title}"></title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="top-lane">
    <div class="top-lane-section">
        <h1 class="txt-white" th:text="#{res_title}"></h1>
        <div class="nav-container">
            <a th:href="@{/categories}" class="nav-button" th:text="#{eq_redirect_cat}"></a>
            <a class="nav-button nav-btn-clicked" th:text="#{eq_redirect_res}"></a>
        </div>
    </div>
    <div class="top-lane-account">
        <a th:if="${user == null}" th:href="@{/sign_in}" class="nav-button" th:text="#{eq_btn_sign_in}"></a>
        <div th:if="${user != null}" style="display: flex; flex-direction: column;">
            <div style="margin-bottom: 10px;">
                <label class="txt-white" th:text="#{nav.logged(${user.email})}"></label>
                <label class="txt-white" th:if="${user.role == 'ADMIN'}" th:text="[ADMIN]"></label>
            </div>
            <button class="nav-button" th:text="#{cat_btn_logout}"
                    th:onclick="window.location.href='/logout';"></button>
        </div>
        <form method="get" action="#">
            <select style="margin-left: 5px;" name="lang" onchange="this.form.submit()">
                <option value="pl" th:selected="${#locale.language == 'pl'}">PL</option>
                <option value="en" th:selected="${#locale.language == 'en'}">EN</option>
                <option value="es" th:selected="${#locale.language == 'es'}">ES</option>
                <option value="fr" th:selected="${#locale.language == 'fr'}">FR</option>
            </select>
        </form>
    </div>
</div>
<div class="center-body">
    <div class="equipment-body">
        <form id="sortForm" onsubmit="event.preventDefault(); sortAndRender();">
            <div class="res-search-div">
                <!--                <div>-->
                <!--                    <label th:text="#{res.search}"></label>-->
                <!--                    <input class="res-input" id="searchInput" name="filterText" type="text" th:value="${filterText}">-->
                <!--                </div>-->
                <div>
                    <label th:text="#{res.sort}"></label>
                    <select class="res-select" id="sortSelect">
                        <option th:value="dateLH" th:text="#{sort_date_LH}"></option>
                        <option th:value="dateHL" th:text="#{sort_date_HL}"
                                th:selected=true></option>
                    </select>
                </div>
                <button class="btn-action" th:text="#{filters_btn}" type="submit" id="filterBtn"></button>
            </div>
        </form>
        <h2 class="res-container" style="align-items: center; padding: 80px 0px;" th:if="${reservationList == null}">
            <label th:text="#{res.blank}"></label>
        </h2>
        <div id="reservationsContainer">
        </div>
    </div>
</div>
<script th:inline="javascript">
    let reservationList = /*[[${reservationList}]]*/ [];
    const user = /*[[${user}]]*/ null;

    const mLangText = {
        code: /*[[#{res.code}]]*/,
        status: /*[[#{res.status}]]*/,
        reservationDate: /*[[#{res.reservationDate}]]*/,
        pickupDate: /*[[#{res.pickupDate}]]*/,
        returnDate: /*[[#{res.returnDate}]]*/,
        quantity: /*[[#{res.quantity}]]*/,
        cost: /*[[#{res.cost}]]*/,
        userFullName: /*[[#{res.userFullName}]]*/,
        userEmail: /*[[#{res.userEmail}]]*/,
        btnPickup: /*[[#{res_btn_pickup}]]*/,
        btnReturn: /*[[#{res_btn_return}]]*/,
        btnCancel: /*[[#{res_btn_cancel}]]*/
    };

    function parseDate(dateStr) {
        return new Date(dateStr.replace(" ", "T"));
    }

    function sortAndRender() {
        const sortType = document.getElementById("sortSelect").value;

        let sortedList = [...reservationList];

        if (sortType === "dateLH") {
            sortedList.sort((a, b) => parseDate(a.reservationDate) - parseDate(b.reservationDate));
        } else if (sortType === "dateHL") {
            sortedList.sort((a, b) => parseDate(b.reservationDate) - parseDate(a.reservationDate));
        }

        renderReservations(sortedList);
    }

    function renderReservations(list) {
        const container = document.getElementById("reservationsContainer");
        container.innerHTML = "";

        list.forEach(reservation => {
            let buttons = "";

            if (user && user.role === 'ADMIN') {
                buttons += `
                    <form enctype="multipart/form-data" method="POST" action="/reservations/change-status">
                        <input type="hidden" name="_method" value="PUT">
                        <input type="hidden" name="reservationID" value="${reservation.reservationID}">
                `;

                if (reservation.status === 'RESERVED') {
                    buttons += `<button name="status" value="IN_USE" type="submit">${mLangText.btnPickup}</button>`;
                }

                if (reservation.status === 'IN_USE') {
                    buttons += `<button name="status" value="RETURNED" type="submit">${mLangText.btnReturn}</button>`;
                }

                if (reservation.status !== 'CANCELLED' && reservation.status !== 'RETURNED') {
                    buttons += `<button name="status" value="CANCELLED" type="submit">${mLangText.btnCancel}</button>`;
                }

                buttons += `</form>`;
            }

            if (user && user.role === 'USER') {
                buttons += `
                    <form enctype="multipart/form-data" method="POST" action="/reservations/change-status">
                        <input type="hidden" name="_method" value="PUT">
                        <input type="hidden" name="reservationID" value="${reservation.reservationID}">
                `;

                if (reservation.status === 'RESERVED') {
                    buttons += `<button name="status" value="CANCELLED" type="submit">${mLangText.btnCancel}</button>`;
                }
                buttons += `</form>`;
            }

            const html = `
                <div class="res-container">
                    <div style="display: flex; flex-direction: column;">
                        <label class="res-label"><b>${mLangText.code}</b> ${reservation.reservationCode}</label>
                        <label class="res-label">${mLangText.status} ${reservation.status}</label>
                        <label class="res-label">${mLangText.reservationDate} ${reservation.reservationDate}</label>
                        <label class="res-label">${mLangText.pickupDate} ${reservation.pickupDate}</label>
                        <label class="res-label">${mLangText.returnDate} ${reservation.returnDate}</label>
                        <label class="res-label">${mLangText.quantity} ${reservation.quantity}</label>
                        <label class="res-label">${mLangText.cost} ${reservation.cost}</label>
                        ${user && user.role === 'ADMIN' ? `
                            <label class="res-label">${mLangText.userFullName} ${reservation.user.name} ${reservation.user.surname}</label>
                            <label class="res-label">${mLangText.userEmail} ${reservation.user.email}</label>
                        ` : ""}
                        ${buttons}
                    </div>
                </div>
            `;

            container.innerHTML += html;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        renderReservations(reservationList);
    });
</script>
</body>
</html>